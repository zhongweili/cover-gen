# 故障排除指南

## 常见问题解决方案

### 1. 不同模型的输出格式差异

**问题描述**: SeedDream 和 OpenAI 模型返回的图片数据格式不同

**格式说明**:

- **SeedDream 3.0 模型**: 直接返回图片 URL，可以直接访问和下载
- **OpenAI GPT-4o Image 模型**: 返回 base64 编码的图片数据，需要转换为可用格式

**图片尺寸**:

- **标准尺寸**: 900×388 像素（微信公众号封面标准）
- **比例**: 约 2.32:1 的宽高比
- **用途**: 完美适配微信公众号文章封面显示

**智能尺寸处理**:

系统采用多层级的尺寸处理策略：

1. **首选方案**: 直接请求 900×388 尺寸
2. **备用方案**: 如果不支持，自动尝试 1024×1024 或 512×512
3. **后处理**: 将非标准尺寸图片自动裁剪为 900×388
4. **质量保证**: 使用智能裁剪算法保持图片主要内容

**裁剪算法**:

- 自动计算最佳裁剪区域
- 保持图片中心内容
- 支持横图和竖图的智能适配
- 输出高质量 PNG 格式

**系统自动处理**:

系统已经自动适配了不同模型的输出格式：

1. **SeedDream 模型**: 直接使用返回的 URL 显示图片
2. **OpenAI 模型**: 自动将 base64 数据转换为 blob URL 用于显示
3. **下载功能**: 优先使用 base64 原始数据（更高质量），备用 URL 下载
4. **复制功能**: 复制可访问的 URL 链接

**技术细节**:

```typescript
// SeedDream 响应格式
{
  "data": [
    {
      "url": "https://example.com/image.png"
    }
  ]
}

// OpenAI 响应格式
{
  "data": [
    {
      "b64_json": "iVBORw0KGgoAAAANSUhEUgAA..."
    }
  ]
}
```

### 2. 请求超时问题

**问题描述**: 生成图片时出现超时错误，特别是使用 OpenAI 模型时

**超时配置说明**:

- **OpenAI GPT-4o Image 模型**: 2 分钟超时 (120 秒)
- **SeedDream 3.0 模型**: 1 分钟超时 (60 秒)
- **默认超时**: 1.5 分钟 (90 秒)

**可能原因**:

- OpenAI 模型处理时间确实较长，特别是复杂的提示词
- 网络连接不稳定
- DMX API 服务器负载较高
- 提示词过于复杂或包含大量细节

**解决方案**:

#### 方案 1: 优化提示词

1. **简化描述**: 使用简洁明确的提示词
2. **避免过度细节**: 不要包含过多的修饰词和细节描述
3. **使用关键词**: 重点突出主要元素和风格

```
❌ 过于复杂的提示词:
"一个非常详细的、具有现代科技感的、采用蓝色和白色渐变色彩的、包含多个几何图形元素的、适合微信公众号使用的、高质量的、专业的封面设计"

✅ 简洁有效的提示词:
"现代科技风格微信封面，蓝白渐变，几何元素"
```

#### 方案 2: 选择合适的模型

1. **SeedDream 3.0** (推荐):

   - 处理速度快 (30-60 秒)
   - 中文理解能力强
   - 稳定性好

2. **OpenAI GPT-4o Image**:
   - 质量最高但速度较慢 (1-2 分钟)
   - 适合对质量要求极高的场景
   - 可能需要特殊权限

#### 方案 3: 网络优化

1. 确保网络连接稳定
2. 避免在网络高峰期使用
3. 如果多次超时，可稍后重试

### 3. API 验证失败 (403 Forbidden)

**问题描述**: 在验证 API Key 时收到 403 错误

**可能原因**:

- API Key 无效或格式错误
- DMX API 账户余额不足
- 浏览器 CORS 安全限制
- API 端点需要特定的请求头

**解决方案**:

#### 方案 1: 跳过验证直接测试

1. 在 API 配置页面点击"跳过验证直接保存"
2. 输入描述并尝试生成图片
3. 如果生成成功，说明 API Key 有效

#### 方案 2: 检查 API Key

1. 登录 [DMX API 控制台](https://www.dmxapi.cn)
2. 确认 API Key 正确复制
3. 检查账户余额是否充足
4. 确认 API Key 权限设置

#### 方案 3: 网络环境检查

1. 尝试使用不同的网络环境
2. 检查是否有防火墙或代理阻止请求
3. 尝试使用 VPN 或其他网络连接

### 4. 特定模型访问失败 (如 OpenAI 模型 403 错误)

**问题描述**: SeedDream 模型工作正常，但 OpenAI 模型返回 403 错误

**可能原因**:

- OpenAI 模型需要特殊权限或更高级别的 API Key
- 账户类型不支持 OpenAI 模型
- 模型 ID 可能已更改或不可用
- 需要额外的费用或订阅

**解决方案**:

1. **使用 SeedDream 3.0 模型** (推荐) - 稳定可用，支持中文
2. **联系 DMX API 支持** 确认 OpenAI 模型的访问权限
3. **检查账户类型** 是否支持高级模型

### 5. 错误信息详解

**系统现在提供详细的错误反馈，包括**:

#### 超时错误 (⏱️)

- 显示具体的超时时间
- 提供模型选择建议
- 给出提示词优化建议

#### 权限错误 (🔒)

- 区分不同类型的权限问题
- 提供具体的解决步骤
- 直接链接到 API 管理页面

#### 网络错误 (🌐)

- 识别 CORS 和网络连接问题
- 提供网络诊断建议
- 指导使用备用方案

#### API Key 错误 (🔑)

- 详细的验证失败原因
- 检查清单和解决步骤
- 账户状态确认指导

### 6. 生成图片失败

**问题描述**: API Key 验证通过但生成图片失败

**解决方案**:

1. 检查提示词是否包含敏感内容
2. 尝试使用不同的 AI 模型 (推荐 SeedDream 3.0)
3. 简化提示词描述
4. 检查账户余额

### 7. 网络连接问题

**问题描述**: 无法连接到 DMX API 服务器

**解决方案**:

1. 检查网络连接
2. 尝试刷新页面
3. 清除浏览器缓存
4. 使用不同的浏览器

### 8. TypeScript 错误

**问题描述**: 开发环境中出现 TypeScript 类型错误

**解决方案**:

```bash
# 重新安装依赖
pnpm install

# 清除缓存并重启开发服务器
pnpm dev
```

### 9. 图片尺寸问题

**问题描述**: 生成的图片尺寸不符合微信公众号封面要求

**可能原因**:

- DMX API 不支持 900×388 尺寸
- 模型限制只能生成特定尺寸
- 网络传输过程中图片被压缩或修改

**解决方案**:

#### 方案 1: 系统自动处理（推荐）

系统已内置智能尺寸处理：

1. **自动检测**: 系统会自动检测 API 是否支持 900×388
2. **智能回退**: 不支持时自动使用 1024×1024 等备用尺寸
3. **前端裁剪**: 自动将方形图片裁剪为微信封面比例
4. **质量保证**: 保持图片清晰度和主要内容

#### 方案 2: 手动验证

如果遇到尺寸问题，可以：

1. **检查控制台**: 查看详细的尺寸处理日志
2. **验证下载**: 下载图片并检查实际尺寸
3. **重新生成**: 尝试重新生成图片

#### 方案 3: 技术细节

```javascript
// 系统处理流程
1. 尝试 900×388 → 成功则直接使用
2. 失败 → 尝试 1024×1024 → 成功则裁剪为 900×388
3. 失败 → 尝试 512×512 → 成功则裁剪为 900×388
4. 全部失败 → 返回错误信息
```

**预期结果**:

- ✅ 下载的图片尺寸为 900×388 像素
- ✅ 图片比例为 2.32:1
- ✅ 图片质量清晰，适合微信使用
- ✅ 主要内容居中显示

### 10. TypeScript 错误

**问题描述**: 开发环境中出现 TypeScript 类型错误

**解决方案**:

```bash
# 重新安装依赖
pnpm install

# 清除缓存并重启开发服务器
pnpm dev
```

## 性能优化建议

### 1. 模型选择策略

- **日常使用**: SeedDream 3.0 (速度快，质量好)
- **高质量需求**: OpenAI GPT-4o Image (质量最高，但较慢)
- **批量生成**: 优先使用 SeedDream 3.0

### 2. 提示词优化

- 使用简洁明确的描述
- 避免重复和冗余信息
- 重点突出核心元素
- 使用专业术语而非口语化描述

### 3. 网络优化

- 在网络状况良好时使用
- 避免同时进行其他大流量操作
- 如遇超时，稍等片刻后重试

## 技术限制说明

### CORS 和浏览器安全限制

由于浏览器的安全策略，直接从前端调用某些 API 可能会遇到以下限制：

1. **User-Agent 头部限制**: 浏览器不允许自定义设置 User-Agent 头部
2. **CORS 策略**: 某些 API 服务器可能没有正确配置 CORS 头部
3. **预检请求**: 复杂的 API 请求可能触发 OPTIONS 预检请求

### 推荐的生产环境解决方案

对于生产环境，建议使用以下方案之一：

1. **后端代理**: 创建后端 API 代理服务
2. **Serverless 函数**: 使用 Vercel Functions 或 Netlify Functions
3. **CORS 代理**: 使用公共 CORS 代理服务（仅用于开发测试）

## 联系支持

如果问题仍然存在，请：

1. 检查浏览器控制台的详细错误信息
2. 记录具体的错误步骤
3. 联系 DMX API 技术支持
4. 在项目 GitHub 仓库提交 Issue

## 调试技巧

### 1. 浏览器控制台

打开浏览器开发者工具 (F12)，查看：

- **Console**: 详细的错误日志和 API 调用信息
- **Network**: API 请求的详细信息和响应
- **Application**: 本地存储的配置信息

### 2. 常用调试信息

系统会在控制台输出详细信息：

- API 请求 URL 和参数
- 请求开始和结束时间
- 具体的错误代码和消息
- 模型和超时配置信息
- 图片尺寸处理过程

### 3. 问题报告模板

报告问题时请提供：

```
- 使用的模型: [SeedDream 3.0 / OpenAI GPT-4o Image]
- 错误类型: [超时 / 403 / 401 / 网络错误 / 尺寸问题]
- 提示词内容: [您使用的提示词]
- 错误消息: [完整的错误信息]
- 图片尺寸: [期望尺寸 vs 实际尺寸]
- 浏览器版本: [Chrome/Firefox/Safari 版本]
- 网络环境: [家庭/办公室/移动网络]
```
